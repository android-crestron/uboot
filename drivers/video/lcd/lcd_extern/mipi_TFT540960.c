/*
 * AMLOGIC lcd external driver.
 *
 * Communication protocol:
 * MIPI 
 *
 */

#include <common.h>
#include <asm/arch/io.h>
#include <asm/arch/gpio.h>
#include <amlogic/aml_lcd_extern.h>

//#define LCD_EXT_DEBUG_INFO
#ifdef LCD_EXT_DEBUG_INFO
#define DBG_PRINT(...)		printf(__VA_ARGS__)
#else
#define DBG_PRINT(...)
#endif

#define LCD_EXTERN_DEVICE_NODE    "/lcd_extern_mipi_TFT540960"
#define LCD_EXTERN_NAME			"lcd_mipi_TFT540960"
#define LCD_EXTERN_TYPE			LCD_EXTERN_MIPI

static struct aml_lcd_extern_driver_t lcd_ext_driver;
static struct lcd_extern_config_t lcd_ext_config ={
	.name = LCD_EXTERN_NAME,
	.type = LCD_EXTERN_TYPE,
};

#define VBPD		(10)
#define VFPD		(10)
#define VSPW		(2)
#define HBPD		(60)
#define HFPD		(30)
#define HSPW		(10)

//******************** mipi command ********************//
//format:  data_type, num, data....
//special: data_type=0xff, num<0xff means delay ms, num=0xff means ending.
//******************************************************//
static unsigned char mipi_init_on_table[300] = {0}; // one element is 268, another is 288, so I use 300 for reserve mempoy space
static unsigned char mipi_init_on_edt_table[] = { //hx8389
    0x29, 4, 0xB9,0xFF,0x83,0x89,
    0x29, 21, 0xB1,0x7F,0x14,0x14,0x35,0x55,0x50,0xD0,0xED,0x51,0x80,
        0x20,0x20,0xF8,0xAA,0xAA,0xA3,0x00,0x80,0x30,0x00,
    0x29, 11, 0xB2, 0x80,0x50,0x0C,0x12,0x40,0x38,0x11,0x64,0x55,0x09,
    0x29, 12, 0xB4,0x10,0x6C,0x10,0x6C,0x00,0x00,0x08,0x78,0x08,0x78,0x88,
    0x29, 36, 0xD3, 0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x32,0x10,0x07,
         0x00,0x07,0x03,0xCB,0x03,0xCB,0x00,0x00,0x00,0x00,
         0x37,0x04,0x09,0x09,0x37,0x00,0x00,0x00,0x0C,0x00,
         0x00,0x00,0x0A,0x00,0x01,
    0x29, 39, 0xD5, 0x18,0x20,0x18,0x22,0x21,0x18,0x23,0x18,0x18,0x02,
         0x18,0x06,0x03,0x18,0x07,0x18,0x18,0x04,0x18,0x00,
         0x05,0x18,0x01,0x18,0x27,0x18,0x25,0x18,0x18,0x26,
         0x18,0x24,0x18,0x00,0x18,0x18,0x18,0x18,
    0x29, 39, 0xD6, 0x18,0x27,0x18,0x25,0x26,0x18,0x24,0x18,0x18,0x01,
         0x18,0x05,0x00,0x18,0x04,0x18,0x18,0x07,0x18,0x03,
         0x06,0x18,0x02,0x18,0x20,0x18,0x22,0x18,0x18,0x21,
         0x18,0x23,0x18,0x18,0x18,0x18,0x18,0x18,

    0x29, 6, 0xD8,0xFF,0xFF,0xFF,0xFF,0XFC,
    0x29, 3, 0xB6,0x20,0x20,
    0x29, 43, 0xE0, 0x00,0x08,0x0E,0x19,0x16,0x3F,0x21,0x37,0x07,0x0C,0x0E,0x18,0x0F,0x12,0x14,0x13,0x14,0x0A,0x16,0x18,0x1A,
         0x00,0x08,0x0E,0x19,0x16,0x3F,0x21,0x38,0x08,0x0C,0x0D,0x18,0x0E,0x12,0x14,0x12,0x13,0x09,0x15,0x17,0x1A,
    0x23, 2,0xCC,0x02,
    0x23, 2,0xD2,0x55,
    0x29, 5,0xC0,0x30,0x15,0x00,0x03,
    0x29, 5,0xC7,0x00,0x80,0x00,0xC0,
   	//////////////
	0x05, 1, 0x11,
	0xff, 150,   //delay 150ms
	0x05, 1, 0x29,
	0xff, 10,    //delay 10ms
	0xff, 0xff,  //ending flag
};

static unsigned char mipi_init_on_truly_table[] = { //hx8389
    0x29, 4, 0xB9,0xFF,0x83,0x89,
	0x29, 21, 0xB1,0x7F,0x10,0x10,0xf2,
		0x32,0x90,0x10,0xEC,0x52,
		0x80,0x20,0x20,0xF8,0xAA,
		0xAA,0xA1,0x00,0x80,0x30,0x00,

	0x29, 11, 0xB2,0x80,0x50,0x05,0x07,
		0x40,0x38,0x11,0x64,0x5D,0x09,
	0x29, 12, 0xB4,0x70,0x70,0x70,0x70,
		0x00,0x00,0x10,0x56,0x10,
		0x56,0xB0,
	0x29, 36, 0xD3,
		0x00,0x00,0x00,0x00,0x00,
		0x08,0x00,0x32,0x10,0x00,
		0x00,0x00,0x03,0xC6,0x03,
		0xC6,0x00,0x00,0x00,0x00,
		0x35,0x33,0x04,0x04,0x37,
		0x00,0x00,0x00,0x05,0x08,
		0x00,0x00,0x0A,0x00,0x01,
	0x29, 39, 0xD5,
		0x18,0x18,0x18,0x18,0x19,
		0x19,0x18,0x18,0x20,0x21,
		0x24,0x25,0x18,0x18,0x18,
		0x18,0x00,0x01,0x04,0x05,
		0x02,0x03,0x06,0x07,0x18,
		0x18,0x18,0x18,0x18,0x18,
		0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
	0x29, 39, 0xD6,
		0x18,0x18,0x18,0x18,0x18,
		0x18,0x19,0x19,0x25,0x24,
		0x21,0x20,0x18,0x18,0x18,
		0x18,0x07,0x06,0x03,0x02,
		0x05,0x04,0x01,0x00,0x18,
		0x18,0x18,0x18,0x18,0x18,
		0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
	0x29, 5, 0xBF,0xB6,0x43,0x50,0xE0,
	0x29, 5, 0xC9,0x1F,0x2E,0x00,0x1E,
	0x29, 43, 0xE0,
		0x00,0x05,0x07,0x33,0x3A,
		0x3F,0x1C,0x42,0x08,0x0B,
		0x0E,0x18,0x0F,0x12,0x15,
		0x13,0x14,0x06,0x11,0x13,
		0x18,0x00,0x05,0x07,0x33,
		0x3A,0x3F,0x1C,0x42,0x08,
		0x0B,0x0E,0x18,0x0E,0x12,
		0x14,0x12,0x13,0x06,0x11,0x13,0x18,
	0x23, 2, 0xD2,0x33,
	0x23, 2, 0xCC,0x02,
	0x29, 5, 0xC7,0x00,0x80,0x00,0xC0,
	0x29, 4, 0xB6,0x6A,0x6A,0x00,

	//***CABC***20120225///
	0x39, 2, 0x51,0xFF,//Write display brightness
	0x39, 2, 0x53,0x24,//Write CTRL display
	0x39, 2, 0x55,0x01,//Write content adaptive brightness control,01~UI mode, 02~ Still mode,03~Moving mode,00~Off
	0x39, 2, 0x5E,0x00,//Write CABC minimum brightness
	//////////////
	0x05, 1, 0x11,
	0xff, 150,   //delay 150ms
	0x05, 1, 0x29,
	0xff, 10,    //delay 10ms
	0xff, 0xff,  //ending flag
};

static unsigned char mipi_init_off_table[] = {
	0x05,1,0x28, //display off
	0xff,10,     //delay 10ms
	0x05,1,0x10, //sleep in
	0xff,10,     //delay 10ms
	0xff,0xff,   //ending flag
};

static int get_lcd_extern_config(void)
{
#ifdef CONFIG_OF_LIBFDT
	char *dt_addr = lcd_ext_driver.dt_addr;
	char *of_node = LCD_EXTERN_DEVICE_NODE;
	struct lcd_extern_config_t *pdata = &lcd_ext_config;
	if (dt_addr) {
		if (get_lcd_extern_dt_data(dt_addr, of_node, pdata) != 0){
			printf("[error] %s probe: failed to get dt data\n", LCD_EXTERN_NAME);
			return -1;
		}
	}
#endif


	if ( 0 == strcmp( getenv("lcmsupplier"), "truly") )
	{
		memcpy( mipi_init_on_table, mipi_init_on_truly_table, sizeof(mipi_init_on_truly_table) );
	}
	else if ( 0 == strcmp( getenv("lcmsupplier"), "edt") )
	{
		memcpy( mipi_init_on_table, mipi_init_on_edt_table, sizeof(mipi_init_on_edt_table) );
	}

	return 0;
}

static struct aml_lcd_extern_driver_t lcd_ext_driver = {
    .name = LCD_EXTERN_NAME,
    .type = LCD_EXTERN_TYPE,
    .reg_read = NULL,
    .reg_write = NULL,
    .power_on = NULL,
    .power_off = NULL,
    .init_on_cmd_8  = &mipi_init_on_table[0],
    .init_off_cmd_8 = &mipi_init_off_table[0],
    .dt_addr = NULL,
    .get_lcd_ext_config = get_lcd_extern_config,
};

struct aml_lcd_extern_driver_t* aml_lcd_extern_get_driver(void)
{
    return &lcd_ext_driver;
}